<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandwidth Keeper Pro</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¶ Bandwidth Keeper Pro</h1>
            <p class="subtitle">æ™ºèƒ½ä¿æŒå…¬ç½‘æ´»è·ƒ Â· é£ç‰›NASä¸“å±</p>
        </div>
        
        <div class="card">
            <h2>âš™ï¸ ä¸‹è½½é…ç½®</h2>
            <div id="links-container"></div>
            <button class="btn-add" onclick="addLinkField()">+ æ·»åŠ é“¾æ¥ (æœ€å¤š5ä¸ª)</button>
        </div>
        
        <div class="card">
            <h2>â±ï¸ å®šæ—¶è§„åˆ™ (Cron)</h2>
            <input type="text" id="cron" placeholder="ç¤ºä¾‹: 0 0 * * * (æ¯æ—¥0ç‚¹)" class="input-field">
            <p class="hint">æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨ (ç•™ç©ºåˆ™ç¦ç”¨å®šæ—¶)</p>
        </div>
        
        <div class="card">
            <h2>ğŸ¢ é™é€Ÿè®¾ç½®</h2>
            <select id="speed-limit" class="select-field">
    <option value="unlimited">æ— é™åˆ¶ (æ¨è)</option>
    <option value="1mbps">1 MB/s (â‰ˆ1024 KB/s)</option>
    <option value="3mbps">3 MB/s (â‰ˆ3072 KB/s)</option>
    <option value="5mbps">5 MB/s (â‰ˆ5120 KB/s)</option>
            </select>
<p class="hint">ğŸ’¡ å•ä½è¯´æ˜ï¼š1 MB/s = 1024 KB/sï¼ˆæ‚¨çš„å®æµ‹é€Ÿåº¦ï¼‰</p>
        </div>
        
        <div class="card">
            <h2>ğŸ”” é’‰é’‰é€šçŸ¥</h2>
            <input type="text" id="dingtalk" placeholder="https://oapi.dingtalk.com/robot/send?access_token=xxx" class="input-field">
            <p class="hint">è·å–æ–¹å¼: é’‰é’‰ç¾¤ â†’ æ™ºèƒ½ç¾¤åŠ©æ‰‹ â†’ è‡ªå®šä¹‰æœºå™¨äºº</p>
        </div>
        
        <div class="action-bar">
            <button class="btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="btn-secondary" onclick="forceRun()">âš¡ ç«‹å³æ‰§è¡Œ</button>
        </div>
        
        <div class="card">
            <h2>ğŸ“œ æœ€è¿‘æ‰§è¡Œæ—¥å¿—</h2>
            <div id="logs" class="log-container">åŠ è½½ä¸­...</div>
            <button class="btn-refresh" onclick="loadLogs()">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–é“¾æ¥å­—æ®µ
        function initLinkFields(links) {
            const container = document.getElementById('links-container');
            container.innerHTML = '';
            (links || Array(5).fill("")).forEach((link, i) => {
                if (i >= 5) return;
                container.innerHTML += `
                    <div class="link-row">
                        <input type="text" class="link-input" placeholder="ä¸‹è½½é“¾æ¥ ${i+1}" value="${link}">
                        ${i > 0 ? '<button class="btn-remove" onclick="removeLink(this)">âˆ’</button>' : ''}
                    </div>
                `;
            });
        }
        
        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const links = Array.from(document.querySelectorAll('.link-input'))
                .map(el => el.value.trim())
                .filter(v => v);
            if (links.length === 0) return alert('è¯·è‡³å°‘å¡«å†™1ä¸ªä¸‹è½½é“¾æ¥');
            if (links.length > 5) return alert('æœ€å¤š5ä¸ªä¸‹è½½é“¾æ¥');
            
            const config = {
                download_links: links,
                cron: document.getElementById('cron').value.trim(),
                speed_limit: document.getElementById('speed-limit').value,
                dingtalk_webhook: document.getElementById('dingtalk').value.trim()
            };
            
            const res = await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            const data = await res.json();
            alert(data.message || 'ä¿å­˜æˆåŠŸï¼');
            if (data.success) loadConfig();
        }
        
        // ç«‹å³æ‰§è¡Œ
        async function forceRun() {
            if (!confirm('ç¡®å®šç«‹å³æ‰§è¡Œä¸‹è½½ä»»åŠ¡ï¼Ÿ')) return;
            await fetch('/api/force-run', {method: 'POST'});
            alert('ä»»åŠ¡å·²è§¦å‘ï¼è¯·æŸ¥çœ‹æ—¥å¿—');
            loadLogs();
        }
        
        // åŠ è½½é…ç½®
        async function loadConfig() {
            const res = await fetch('/api/config');
            const config = await res.json();
            initLinkFields(config.download_links);
            document.getElementById('cron').value = config.cron || '0 0 * * *';
            document.getElementById('speed-limit').value = config.speed_limit || 'unlimited';
            document.getElementById('dingtalk').value = config.dingtalk_webhook || '';
        }
        
        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = 'â³ åŠ è½½ä¸­...';
            const res = await fetch('/api/logs');
            const data = await res.json();
            logsDiv.innerHTML = data.logs.map(l => 
                `<div class="log-item">${l.replace(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/, '<span class="timestamp">[$1]</span>')}</div>`
            ).join('') || '<div class="log-empty">æš‚æ— æ—¥å¿—</div>';
        }
        
        // è¾…åŠ©å‡½æ•°
        function addLinkField() {
            if (document.querySelectorAll('.link-input').length >= 5) {
                alert('å·²è¾¾æœ€å¤§é“¾æ¥æ•°(5)');
                return;
            }
            const container = document.getElementById('links-container');
            const idx = container.children.length + 1;
            container.insertAdjacentHTML('beforeend', `
                <div class="link-row">
                    <input type="text" class="link-input" placeholder="ä¸‹è½½é“¾æ¥ ${idx}">
                    <button class="btn-remove" onclick="removeLink(this)">âˆ’</button>
                </div>
            `);
        }
        function removeLink(btn) {
            btn.parentElement.remove();
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            loadConfig();
            loadLogs();
            setInterval(loadLogs, 30000); // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ—¥å¿—
        };
    </script>
</body>
</html>